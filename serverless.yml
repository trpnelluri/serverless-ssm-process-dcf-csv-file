# Welcome to serverless. Read the docs
# https://serverless.com/framework/docs/

# Serverless.yml is the configuration the CLI
# uses to deploy your code to your provider of choice

# The `service` block is the name of the service
service: serverless-ssm-process-dcf-csv-file

frameworkVersion: '3'

params:
  default:
    domain: ${sls:stage}.preview.myapp.com
  dev:
    sm_pgs_db_auth: dev_esmd_db_secret
    pgs_idle_time_out: 90000
    pgs_conn_time_out: 5000
    bucket_name: esmd-aws-outbound-siva
    doc_code_err_data: ESMD_707^ERR_CSV_DOC_CD_MIS_INVLD^EITHER THE DOCUMENT CODE IS MISSING OR THE FORMAT IS INVALID FOR RECORD {0}
    doc_des_err_data: ESMD_707^ERR_CSV_DOC_DESC_MIS^EITHER THE DOCUMENT DESCRIPTION IS MISSING OR IS INVALID FOR RECORD {0}
    act_status_err_data: ESMD_709^ERR_CSV_ACTN_STUS_MIS^EITHER THE ACTION STATUS IS MISSING OR INVALID - VALID VALUES ARE(A,U,M,E) FOR RECORD {0}
    act_date_err_data: ESMD_710^ERR_CSV_ACTN_DT_MIS^EITHER THE ACTION DATE IS MISSING OR INVALID FOR RECORD {0}
    doc_code_regex_value: /^([0-9]{6})$/
    doc_des_regex_value: /^[\s\S]{1,1000}$/
    act_status_regex_value: /^[A | U | M | E]$/
    act_date_regex_value: /^(0[1-9]|1[0-2])(0[1-9]|1\d|2\d|3[01])(19|20|21)\d{2}$/
  val:
    domain: preview.myapp.com

  uat:
    domain: preview.myapp.com
    
  prod:
    domain: preview.myapp.com

# The `provider` block defines where your service will be deployed
provider:
  name: aws
  runtime: nodejs12.x

  iam:
    role: arn:aws:iam::030556409702:role/esmd_serverless_role

  deploymentBucket:
    name: esmd-aws-generic-bucket-siva # Overwrite the default deployment bucket
    #serverSideEncryption: AES256 # when using server-side encryption

# The `functions` block defines what code to deploy
functions:
  processDCFFile:
    handler: index.handler
    runtime: nodejs12.x
    vpc:
      securityGroupIds:
        - sg-03151b54033e5158d
      subnetIds:
        - subnet-0c3a4f372e820d41c
        - subnet-02e013088b137a8ce

    memorySize: 256 # optional, in MB, default is 1024
    timeout: 10 # 
    # provisionedConcurrency: 3 # optional, Count of provisioned lambda instances
    # reservedConcurrency: 5 # optional, reserved concurrency limit for this function. By default, AWS uses account concurrency limit
    package:
      individually: true
    events: 
      - sqs: arn:aws:sqs:us-east-1:030556409702:esmd-process-dcf-queue.fifo 
    environment:
      ENVIRONMENT_NAME: dev
      SM_PGS_DB_AUTH: ${param:sm_pgs_db_auth}
      PGS_IDLE_TIME_OUT: ${param:pgs_idle_time_out}
      PGS_CONN_TIME_OUT: ${param:pgs_conn_time_out}
      BUCKET_NAME: ${param:bucket_name}
      DOC_CODE_ERR_DATA: ${param:doc_code_err_data}
      DOC_DES_ERR_DATA: ${param:doc_des_err_data}
      ACT_STATUS_ERR_DATA: ${param:act_status_err_data}
      ACT_DATE_ERR_DATA: ${param:act_date_err_data}
      DOC_CODE_REGEX_VALUE: ${param:doc_code_regex_value}
      DOC_DES_REGEX_VALUE: ${param:doc_des_regex_value}
      ACT_STATUS_REGEX_VALUE: ${param:act_status_regex_value}
      ACT_DATE_REGEX_VALUE: ${param:act_date_regex_value}
      

